# Scenario: Secret Rotation Failure
#
# Root Cause: Database password rotation completed but application
# pods still using old credentials, causing authentication failures.

name: secret-rotation-failure
description: >
  Database credentials rotated but application not updated.
  Pods using cached old credentials failing to authenticate.

timing:
  incident_start: "2026-02-03T02:00:00Z"
  baseline_window_minutes: 30
  incident_window_minutes: 30

scope:
  service: user-service
  environment: prod
  secret: user-db-credentials

monitor:
  id: 10202
  name: "Database Authentication Failures"
  type: metric alert
  query: "sum(last_5m):sum:postgresql.connections.auth_failures{db:user-db,env:prod}.as_count() > 10"
  message: "Database authentication failures detected. Check credentials."
  tags:
    - db:user-db
    - env:prod

metrics:
  # Database auth metrics - KEY INDICATORS
  - name: postgresql.connections.auth_failures
    type: count
    tags: ["db:user-db", "env:prod"]
    baseline:
      value: 0
    incident:
      pattern: spike
      value: 1000  # All connections failing
      noise: 100

  - name: postgresql.connections.successful
    type: count
    tags: ["db:user-db", "env:prod"]
    baseline:
      value: 500
    incident:
      value: 0  # None working

  # Connection pool metrics
  - name: jvm.db.pool.active
    type: gauge
    tags: ["service:user-service", "pool:HikariPool-1"]
    baseline:
      value: 30
    incident:
      value: 0  # No connections

  - name: jvm.db.pool.timeout
    type: count
    tags: ["service:user-service", "pool:HikariPool-1"]
    baseline:
      value: 0
    incident:
      value: 500

  - name: jvm.db.pool.connection_errors
    type: count
    tags: ["service:user-service", "pool:HikariPool-1"]
    baseline:
      value: 0
    incident:
      value: 1000  # Auth failures

  # Service metrics
  - name: trace.user-service.request.errors
    type: count
    tags: ["service:user-service", "env:prod"]
    baseline:
      value: 5
    incident:
      value: 2000  # All DB operations failing
      noise: 200

  - name: trace.user-service.request.duration
    type: gauge
    unit: millisecond
    tags: ["service:user-service", "env:prod"]
    baseline:
      value: 50
      noise: 20
    incident:
      value: 5000  # Timeout waiting for connection

  # Error breakdown
  - name: app.errors
    type: count
    tags: ["service:user-service", "error.type:AuthenticationException"]
    baseline:
      value: 0
    incident:
      value: 1000

  # Secret age
  - name: app.secret.age_seconds
    type: gauge
    tags: ["service:user-service", "secret:user-db-credentials"]
    baseline:
      value: 86400  # 1 day
    incident:
      value: 604800  # 7 days - stale!

logs:
  baseline:
    - timestamp_offset_minutes: -20
      service: user-service
      status: info
      message: "User authenticated successfully: user-12345"

  incident:
    # Secret rotation event
    - timestamp_offset_minutes: 0
      service: vault
      status: info
      message: "Secret rotated: user-db-credentials"
      attributes:
        secret.path: "secret/data/prod/user-db-credentials"
        rotation.scheduled: true
        rotation.old_version: 5
        rotation.new_version: 6

    # Database accepting new creds
    - timestamp_offset_minutes: 0
      service: postgresql
      host: user-db-primary
      status: info
      message: "Password changed for user 'user_service_app'"
      attributes:
        db.user: user_service_app
        db.operation: ALTER USER

    # Application auth failures
    - timestamp_offset_minutes: 1
      service: user-service
      status: error
      message: "PSQLException: FATAL: password authentication failed for user 'user_service_app'"
      attributes:
        error.type: PSQLException
        error.message: "password authentication failed"
        db.user: user_service_app
        db.host: user-db-primary

    - timestamp_offset_minutes: 1
      service: user-service
      status: error
      message: "HikariPool-1: Failed to acquire connection"
      attributes:
        error.type: SQLException
        error.cause: "password authentication failed"
        pool.name: HikariPool-1

    - timestamp_offset_minutes: 2
      service: user-service
      status: error
      message: "All connection attempts failed - cannot reach database"
      attributes:
        pool.name: HikariPool-1
        pool.active: 0
        pool.max: 50
        error.reason: "Authentication failed"

    # Health check failures
    - timestamp_offset_minutes: 3
      service: user-service
      status: error
      message: "Health check failed: database connection unavailable"
      attributes:
        health.component: db
        health.status: DOWN
        health.details: "Authentication failed"

    - timestamp_offset_minutes: 3
      service: kubernetes
      status: warn
      message: "Readiness probe failed for user-service pods"
      attributes:
        kubernetes.event.reason: Unhealthy
        kubernetes.deployment: user-service

    # Secret mismatch detected
    - timestamp_offset_minutes: 10
      service: secret-checker
      status: error
      message: "Secret version mismatch: pod using version 5, Vault has version 6"
      attributes:
        secret.name: user-db-credentials
        secret.pod_version: 5
        secret.vault_version: 6
        pods.affected: 5

spans:
  baseline:
    - trace_id: trace-user-base-001
      spans:
        - span_id: span-user-001
          service: user-service
          resource: "GET /users/{id}"
          span_kind: server
          duration_ns: 50000000
          is_error: false

        - span_id: span-db-001
          service: user-service
          resource: "SELECT * FROM users WHERE id = $1"
          span_kind: client
          duration_ns: 10000000
          peer.service: postgres

  incident:
    - trace_id: trace-user-inc-001
      spans:
        - span_id: span-user-inc-001
          service: user-service
          resource: "GET /users/{id}"
          span_kind: server
          duration_ns: 5000000000  # 5s timeout
          is_error: true
          http.status_code: 503

        - span_id: span-db-inc-001
          service: user-service
          resource: "SELECT * FROM users WHERE id = $1"
          span_kind: client
          duration_ns: 5000000000
          is_error: true
          peer.service: postgres
          error.type: AuthenticationException
          error.message: "password authentication failed"

events:
  - id: 10201
    title: "Vault: Scheduled secret rotation"
    text: "Automatic rotation of user-db-credentials"
    date_happened_offset_minutes: 0
    source: vault
    alert_type: info
    tags:
      - secret:user-db-credentials
      - rotation:scheduled

  - id: 10202
    title: "Alert: Database auth failures"
    text: "High authentication failure rate for user-db"
    date_happened_offset_minutes: 1
    source: datadog
    alert_type: error
    tags:
      - db:user-db

  - id: 10203
    title: "Alert: user-service unhealthy"
    text: "All user-service pods failing health checks"
    date_happened_offset_minutes: 3
    source: datadog
    alert_type: error
    tags:
      - service:user-service

  - id: 10204
    title: "Manual: Force pod restart initiated"
    text: "Rolling restart to pick up new secrets"
    date_happened_offset_minutes: 15
    source: operations
    alert_type: info
    tags:
      - service:user-service
      - action:restart

expected_rca:
  root_cause: "Database password rotated but pods not restarted"
  contributing_factors:
    - "Vault automatic rotation at 02:00"
    - "Application pods caching old credentials in memory"
    - "No secret sync mechanism (e.g., Vault Agent, External Secrets)"
    - "Pods not configured to restart on secret change"
  recommended_actions:
    - "Rolling restart all user-service pods immediately"
    - "Implement Vault Agent sidecar for dynamic secrets"
    - "Use Reloader to auto-restart on secret changes"
    - "Add secret version monitoring"
    - "Test secret rotation in staging regularly"
