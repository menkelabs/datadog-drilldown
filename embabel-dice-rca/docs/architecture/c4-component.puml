@startuml C4_Component
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()

title Component Diagram - Embabel Dice RCA Agent

Container_Boundary(agentBoundary, "RCA Agent") {
    Component(agent, "RcaAgent", "Service", "Main orchestrator")
    Component(categorize, "categorize", "Action", "Classify incident")
    Component(parse, "parse", "Action", "Extract scope")
    Component(collect, "collect", "Action", "Gather evidence")
    Component(analyze, "analyze", "Action", "Identify causes")
    Component(report, "report", "Action", "Generate output")
}

Container_Boundary(toolsBoundary, "MCP Tools") {
    Component(logTool, "search_logs", "@LlmTool", "")
    Component(metricTool, "query_metrics", "@LlmTool", "")
    Component(traceTool, "search_traces", "@LlmTool", "")
}

Container_Boundary(engineBoundary, "Engine") {
    Component(logAna, "LogAnalyzer", "Service", "Clustering")
    Component(metricAna, "MetricAnalyzer", "Service", "Anomalies")
    Component(scoring, "ScoringEngine", "Service", "Ranking")
}

Container_Boundary(clientBoundary, "Datadog Client") {
    Component(ddInt, "DatadogClient", "Interface", "Abstract API")
    Component(ddReal, "RealHttpDatadogClient", "Implementation", "Production HTTP client")
    Component(ddMock, "MockDatadogClient", "Mock", "Scenario-based testing")
}

Container_Boundary(bridgeBoundary, "DICE Bridge") {
    Component(diceCli, "DiceClient", "REST", "HTTP client for DICE API")
    Component(diceSvc, "DiceIngestionService", "Service", "Alert & evidence ingestion")
}

Container_Boundary(testBoundary, "Test Framework") {
    Component(testFw, "DiceKnowledgeTestFramework", "Test Framework", "Loads prior knowledge\nSimulates alerts\nVerifies conclusions")
    Component(priorKnowledge, "PriorKnowledge", "Model", "Architecture, Dependencies\nFailure Patterns, Past Incidents\nRunbooks, SLOs")
    Component(scenarioLoader, "ScenarioLoader", "YAML Parser", "Loads test scenarios\nfrom YAML files")
    Component(testScenarios, "TestScenarios", "Fixtures", "Pre-built Datadog scenarios\nfor integration testing")
}

Rel(agent, collect, "Uses")
Rel(collect, logTool, "Calls")
Rel(logTool, ddInt, "Uses")
Rel(ddInt, ddReal, "Impl")
Rel(ddInt, ddMock, "Impl")

Rel(agent, analyze, "Uses")
Rel(analyze, scoring, "Calls")
Rel(agent, diceCli, "Pushes")

Rel(testFw, diceCli, "Ingests prior knowledge")
Rel(testFw, ddMock, "Configures scenarios")
Rel(scenarioLoader, ddMock, "Loads YAML data")
Rel(testFw, priorKnowledge, "Uses")
Rel(testScenarios, ddMock, "Provides data")

@enduml
